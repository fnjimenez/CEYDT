<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kahoot - Estudio del Trabajo</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .login-screen {
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .game-screen {
            display: none;
            min-height: 600px;
        }

        .results-screen {
            display: none;
            padding: 40px;
            text-align: center;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
        }

        .score-display {
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f;
        }

        .question-container {
            padding: 40px;
            text-align: center;
        }

        .question-number {
            color: #7f8c8d;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .option {
            padding: 25px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            color: white;
            text-align: center;
        }

        .option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .option-a { background: #e74c3c; }
        .option-b { background: #3498db; }
        .option-c { background: #2ecc71; }
        .option-d { background: #f39c12; }

        .option.selected {
            border-color: #2c3e50;
            transform: scale(1.05);
        }

        .timer-bar {
            height: 10px;
            background: #ecf0f1;
            margin: 20px 0;
            border-radius: 5px;
            overflow: hidden;
        }

        .timer-progress {
            height: 100%;
            background: #e74c3c;
            width: 100%;
            transition: width 1s linear;
        }

        .ranking {
            max-width: 600px;
            margin: 0 auto;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }

        .final-score {
            font-size: 48px;
            font-weight: bold;
            color: #f1c40f;
            margin: 20px 0;
        }

        .achievement {
            display: inline-block;
            background: #f1c40f;
            color: #2c3e50;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 20px;
            font-weight: bold;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .correct-answer {
            animation: correctAnswer 0.5s ease;
            background: #27ae60 !important;
        }

        .incorrect-answer {
            animation: incorrectAnswer 0.5s ease;
            background: #e74c3c !important;
        }

        .admin-panel {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla de Login -->
        <div class="login-screen" id="loginScreen">
            <h1>üéØ Kahoot - Estudio del Trabajo</h1>
            <p class="subtitle">20 Reactivos - Evaluaci√≥n Final</p>
            
            <div class="login-form">
                <h2>Registro de Estudiante</h2>
                
                <div id="firebaseStatus" class="status-message status-warning">
                    üîÑ Conectando con Firebase...
                </div>

                <input type="text" id="studentName" placeholder="Tu nombre completo" maxlength="20">
                <input type="text" id="studentId" placeholder="Matr√≠cula" maxlength="10">
                <button class="btn btn-primary" onclick="registerStudent()" id="startBtn">
                    üéÆ ¬°Comenzar Evaluaci√≥n!
                </button>

                <!-- Panel Admin -->
                <div class="admin-panel">
                    <h4>üîß Panel de Control</h4>
                    <button class="btn btn-warning" onclick="showStats()">Ver Estad√≠sticas</button>
                    <button class="btn btn-danger" onclick="resetGame()">Reiniciar Juego</button>
                </div>
            </div>
        </div>

        <!-- Pantalla de Juego -->
        <div class="game-screen" id="gameScreen">
            <div class="header">
                <div class="player-info">
                    <div class="avatar" id="playerAvatar">U</div>
                    <div>
                        <div id="playerName">Estudiante</div>
                        <div class="score-display" id="currentScore">0 puntos</div>
                    </div>
                </div>
                <div class="question-counter" id="questionCounter">Pregunta 1/20</div>
            </div>

            <div class="question-container">
                <div class="question-number" id="questionNumber">Pregunta #1</div>
                <div class="question-text" id="questionText">Cargando pregunta...</div>
                
                <div class="timer-bar">
                    <div class="timer-progress" id="timerProgress"></div>
                </div>

                <div class="options-grid">
                    <div class="option option-a" onclick="selectOption('a')">A) Cargando...</div>
                    <div class="option option-b" onclick="selectOption('b')">B) Cargando...</div>
                    <div class="option option-c" onclick="selectOption('c')">C) Cargando...</div>
                    <div class="option option-d" onclick="selectOption('d')">D) Cargando...</div>
                </div>

                <button class="btn btn-success" id="submitBtn" onclick="submitAnswer()" disabled>Confirmar Respuesta</button>
            </div>
        </div>

        <!-- Pantalla de Resultados -->
        <div class="results-screen" id="resultsScreen">
            <div class="results-header">
                <h1>üèÜ ¬°Evaluaci√≥n Terminada!</h1>
                <div class="final-score" id="finalScore">0 puntos</div>
                <p id="performanceMessage">¬°Excelente trabajo!</p>
            </div>

            <div class="achievements" id="achievementsContainer"></div>

            <h2>üèÖ Ranking General</h2>
            <div class="ranking" id="rankingList">
                <div class="ranking-item">
                    <div>Cargando ranking en tiempo real...</div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="restartGame()">Intentar Otra Vez</button>
                <button class="btn btn-warning" onclick="showDetailedResults()">Ver Resultados Detallados</button>
            </div>
        </div>
    </div>

    <script>
        // üî• CONFIGURACI√ìN FIREBASE - PROYECTO REAL
        const firebaseConfig = {
            apiKey: "AIzaSyDm385YCrTr_Ayzdkm6pSUC8BDtIz5aYys",
            authDomain: "evaluacionfinalcurso-f3f5b.firebaseapp.com",
            projectId: "evaluacionfinalcurso-f3f5b",
            storageBucket: "evaluacionfinalcurso-f3f5b.firebasestorage.app",
            messagingSenderId: "275243119732",
            appId: "1:275243119732:web:ecce0263523f8b1e4a0d21",
            measurementId: "G-V3JZVEEFM4"
        };

        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            console.log("‚úÖ Firebase inicializado correctamente");
        } catch (error) {
            console.error("‚ùå Error inicializando Firebase:", error);
        }

        const db = firebase.firestore();

        // Variables del juego
        let currentPlayer = {};
        let currentQuestion = 0;
        let score = 0;
        let selectedOption = null;
        let timeLeft = 30;
        let timerInterval;
        let questions = [];

        // BANCO DE 20 PREGUNTAS REALES
        const questionBank = [
            // IISE BOK (5 preguntas)
            {
                question: "¬øCu√°l de las siguientes √°reas del IISE se enfoca en la disposici√≥n f√≠sica de recursos?",
                options: ["Work Design & Measurement", "Facilities Engineering & Energy Management", "Operations Research & Analysis", "Quality & Reliability Engineering"],
                correct: "b",
                points: 100,
                category: "IISE_BOK"
            },
            {
                question: "¬øQu√© √°rea del IISE utiliza modelos matem√°ticos para optimizar sistemas?",
                options: ["Engineering Economic Analysis", "Operations Research & Analysis", "Information Engineering", "Supply Chain Management"],
                correct: "b",
                points: 100,
                category: "IISE_BOK"
            },
            {
                question: "¬øQu√© √°rea del IISE se enfoca en la capacidad de sistemas para funcionar bajo condiciones espec√≠ficas?",
                options: ["Quality Engineering", "Reliability Engineering", "Safety Engineering", "Information Engineering"],
                correct: "b",
                points: 150,
                category: "IISE_BOK"
            },
            {
                question: "¬øCu√°l NO es una de las √°reas principales del Cuerpo de Conocimiento del IISE?",
                options: ["Work Design & Measurement", "Operations Research & Analysis", "Marketing Engineering", "Engineering Economic Analysis"],
                correct: "c",
                points: 200,
                category: "IISE_BOK"
            },
            {
                question: "¬øQu√© √°rea del IISE se relaciona con el an√°lisis de costos y beneficios de proyectos?",
                options: ["Engineering Economic Analysis", "Facilities Engineering", "Quality Engineering", "Information Engineering"],
                correct: "a",
                points: 150,
                category: "IISE_BOK"
            },

            // FUNDAMENTOS (4 preguntas)
            {
                question: "¬øQui√©n es considerado el padre de la administraci√≥n cient√≠fica?",
                options: ["Henry Gantt", "Frederick Taylor", "Frank Gilbreth", "Henry Ford"],
                correct: "b",
                points: 150,
                category: "Fundamentos"
            },
            {
                question: "¬øCu√°l de los siguientes es considerado precursor fundamental del estudio del trabajo?",
                options: ["Henry Gantt", "Frederick Taylor", "Frank Gilbreth", "Todos los anteriores"],
                correct: "d",
                points: 100,
                category: "Fundamentos"
            },
            {
                question: "Seg√∫n los Gilbreth, ¬øc√≥mo se denominan los elementos b√°sicos del movimiento humano?",
                options: ["Therbligs", "Movimientos elementales", "Micromovimientos", "Unidades de movimiento"],
                correct: "a",
                points: 200,
                category: "Fundamentos"
            },
            {
                question: "¬øQu√© principio de Taylor busca encontrar 'la mejor manera' de realizar una tarea?",
                options: ["Principio de preparaci√≥n", "Principio de ejecuci√≥n", "Principio de planeaci√≥n", "Principio de estandarizaci√≥n"],
                correct: "c",
                points: 150,
                category: "Fundamentos"
            },

            // ESTUDIO DE TIEMPOS (4 preguntas)
            {
                question: "¬øQu√© representa el Tiempo Est√°ndar en estudio de tiempos?",
                options: ["Tiempo promedio observado", "Tiempo que deber√≠a tomar una tarea", "Tiempo m√°s r√°pido registrado", "Tiempo con descansos incluidos"],
                correct: "b",
                points: 200,
                category: "Estudio_Tiempos"
            },
            {
                question: "¬øQu√© representa el Tiempo Normal?",
                options: ["Tiempo observado √ó Factor de valoraci√≥n", "Tiempo observado + Suplementos", "Tiempo est√°ndar - Tiempo de descanso", "Tiempo promedio de varios ciclos"],
                correct: "a",
                points: 150,
                category: "Estudio_Tiempos"
            },
            {
                question: "Seg√∫n el sistema Westinghouse, ¬øqu√© factor NO se considera para ajustar el tiempo observado?",
                options: ["Habilidad", "Esfuerzo", "Condiciones", "Edad del operario"],
                correct: "d",
                points: 100,
                category: "Estudio_Tiempos"
            },
            {
                question: "¬øQu√© tipo de suplemento aplica para necesidades personales como ir al ba√±o?",
                options: ["Suplementos constantes", "Suplementos variables", "Suplementos por fatiga", "Suplementos por contingencia"],
                correct: "a",
                points: 150,
                category: "Estudio_Tiempos"
            },

            // HERRAMIENTAS (4 preguntas)
            {
                question: "¬øQu√© t√©cnica usa c√≥digos predefinidos para analizar movimientos?",
                options: ["Diagrama de flujo", "Diagrama bimanual", "MTM (Methods-Time Measurement)", "Estudio de tiempos con cron√≥metro"],
                correct: "c",
                points: 250,
                category: "Herramientas"
            },
            {
                question: "¬øQu√© tipo de diagrama muestra simult√°neamente las actividades de un operario y las de una m√°quina?",
                options: ["Diagrama de flujo de proceso", "Diagrama de operaciones", "Diagrama hombre-m√°quina", "Diagrama de recorrido"],
                correct: "c",
                points: 150,
                category: "Herramientas"
            },
            {
                question: "¬øQu√© s√≠mbolo ASME se utiliza para representar una operaci√≥n?",
                options: ["C√≠rculo", "Cuadrado", "Tri√°ngulo", "Flecha"],
                correct: "a",
                points: 100,
                category: "Herramientas"
            },
            {
                question: "¬øQu√© diagrama muestra el flujo de materiales sobre el layout de la planta?",
                options: ["Diagrama de proceso", "Diagrama de operaciones", "Diagrama de recorrido", "Diagrama bimanual"],
                correct: "c",
                points: 150,
                category: "Herramientas"
            },

            // ERGONOM√çA (3 preguntas)
            {
                question: "¬øQu√© principio de la econom√≠a de movimientos establece que las manos deben trabajar coordinadamente?",
                options: ["Principio de simultaneidad", "Principio de simetr√≠a", "Principio de ritmo", "Principio de continuidad"],
                correct: "a",
                points: 150,
                category: "Ergonomia"
            },
            {
                question: "¬øQu√© ciencia estudia las medidas corporales para adaptar el trabajo al trabajador?",
                options: ["Biomec√°nica", "Antropometr√≠a", "Fisiolog√≠a", "Psicolog√≠a"],
                correct: "b",
                points: 100,
                category: "Ergonomia"
            },
            {
                question: "¬øQu√© herramienta se usa para analizar movimientos de ambas manos simult√°neamente?",
                options: ["Diagrama de flujo", "Diagrama bimanual", "Diagrama de recorrido", "Diagrama hombre-m√°quina"],
                correct: "b",
                points: 200,
                category: "Ergonomia"
            }
        ];

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        async function initializeFirebase() {
            try {
                // Probar conexi√≥n
                await db.collection('connection').doc('test').set({
                    timestamp: new Date(),
                    status: 'connected',
                    project: 'evaluacionfinalcurso-f3f5b'
                });
                
                document.getElementById('firebaseStatus').className = 'status-message status-success';
                document.getElementById('firebaseStatus').textContent = '‚úÖ Conectado a Firebase correctamente';
                
                console.log("‚úÖ Firebase conectado y funcionando");
                
            } catch (error) {
                document.getElementById('firebaseStatus').className = 'status-message status-error';
                document.getElementById('firebaseStatus').textContent = '‚ùå Error: ' + error.message;
                console.error("Error Firebase:", error);
            }
        }

        // ========== FUNCIONES PRINCIPALES ==========

        async function registerStudent() {
            const name = document.getElementById('studentName').value;
            const id = document.getElementById('studentId').value;

            if (!name || !id) {
                alert('Por favor ingresa tu nombre y matr√≠cula');
                return;
            }

            currentPlayer = {
                name: name,
                id: id,
                avatar: name.charAt(0).toUpperCase(),
                score: 0,
                startTime: new Date(),
                completed: false
            };

            try {
                // Guardar en Firebase
                await db.collection('players').doc(id).set(currentPlayer);
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
                
                document.getElementById('playerName').textContent = name;
                document.getElementById('playerAvatar').textContent = currentPlayer.avatar;
                
                // Mezclar preguntas
                questions = [...questionBank].sort(() => Math.random() - 0.5);
                loadQuestion();
                
            } catch (error) {
                alert('Error al registrar: ' + error.message);
            }
        }

        function loadQuestion() {
            if (currentQuestion >= questions.length) {
                endGame();
                return;
            }

            const q = questions[currentQuestion];
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('questionNumber').textContent = `Pregunta #${currentQuestion + 1}`;
            document.getElementById('questionCounter').textContent = `Pregunta ${currentQuestion + 1}/${questions.length}`;

            const options = document.querySelectorAll('.option');
            options.forEach((opt, index) => {
                const letter = String.fromCharCode(97 + index);
                opt.textContent = `${letter.toUpperCase()}) ${q.options[index]}`;
                opt.className = `option option-${letter}`;
                opt.onclick = () => selectOption(letter);
                opt.style.pointerEvents = 'auto';
            });

            selectedOption = null;
            document.getElementById('submitBtn').disabled = true;
            resetTimer();
        }

        function selectOption(option) {
            selectedOption = option;
            document.getElementById('submitBtn').disabled = false;
            
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            document.querySelector(`.option-${option}`).classList.add('selected');
        }

        async function submitAnswer() {
            if (!selectedOption) return;

            const q = questions[currentQuestion];
            const isCorrect = selectedOption === q.correct;
            const optionElement = document.querySelector(`.option-${selectedOption}`);

            // Registrar respuesta en Firebase
            await db.collection('answers').add({
                playerId: currentPlayer.id,
                playerName: currentPlayer.name,
                questionIndex: currentQuestion,
                question: q.question,
                selectedOption: selectedOption,
                correctOption: q.correct,
                isCorrect: isCorrect,
                points: isCorrect ? q.points : 0,
                timestamp: new Date(),
                category: q.category
            });

            if (isCorrect) {
                score += q.points;
                optionElement.classList.add('correct-answer');
                showPointsAnimation(q.points);
            } else {
                optionElement.classList.add('incorrect-answer');
                document.querySelector(`.option-${q.correct}`).classList.add('correct-answer');
            }

            updateScore();
            
            document.querySelectorAll('.option').forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            document.getElementById('submitBtn').disabled = true;

            setTimeout(() => {
                currentQuestion++;
                loadQuestion();
            }, 2000);
        }

        function showPointsAnimation(points) {
            const pointsDiv = document.createElement('div');
            pointsDiv.textContent = `+${points}`;
            pointsDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 48px;
                font-weight: bold;
                color: #27ae60;
                z-index: 1000;
                animation: floatUp 1s ease-out;
            `;
            
            document.body.appendChild(pointsDiv);
            
            setTimeout(() => {
                pointsDiv.remove();
            }, 1000);
        }

        async function updateScore() {
            document.getElementById('currentScore').textContent = `${score} puntos`;
            currentPlayer.score = score;
            
            await db.collection('players').doc(currentPlayer.id).update({
                score: score,
                lastUpdate: new Date()
            });
        }

        function resetTimer() {
            timeLeft = 30;
            clearInterval(timerInterval);
            
            const timerProgress = document.getElementById('timerProgress');
            timerProgress.style.width = '100%';
            timerProgress.style.background = '#2ecc71';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                const progress = (timeLeft / 30) * 100;
                timerProgress.style.width = `${progress}%`;
                
                if (timeLeft <= 10) {
                    timerProgress.style.background = '#e74c3c';
                } else if (timeLeft <= 20) {
                    timerProgress.style.background = '#f39c12';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    selectedOption = null;
                    submitAnswer();
                }
            }, 1000);
        }

        async function endGame() {
            clearInterval(timerInterval);
            
            // Guardar resultado final
            currentPlayer.finalScore = score;
            currentPlayer.endTime = new Date();
            currentPlayer.completed = true;
            
            await db.collection('players').doc(currentPlayer.id).update(currentPlayer);

            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            document.getElementById('finalScore').textContent = `${score} puntos`;
            showPerformanceMessage();
            showAchievements();
            loadRanking();
            updateGlobalStats();
        }

        function showPerformanceMessage() {
            const percentage = (score / 3000) * 100; // M√°ximo 3000 puntos
            let message = '';
            
            if (percentage >= 90) message = 'üèÜ ¬°Excelente! Dominas completamente el Estudio del Trabajo';
            else if (percentage >= 80) message = 'üéØ ¬°Muy bien! Tienes conocimientos avanzados';
            else if (percentage >= 70) message = 'üëç Buen desempe√±o, conocimientos s√≥lidos';
            else if (percentage >= 60) message = 'üìö Nivel satisfactorio, sigue practicando';
            else message = 'üí™ Sigue estudiando, identificar√°s √°reas de mejora';
            
            document.getElementById('performanceMessage').textContent = message;
        }

        function showAchievements() {
            const achievements = document.getElementById('achievementsContainer');
            achievements.innerHTML = '';
            
            const percentage = (score / 3000) * 100;
            
            if (percentage >= 90) {
                achievements.innerHTML += '<div class="achievement">üèÖ Experto en IISE</div>';
            }
            if (percentage >= 80) {
                achievements.innerHTML += '<div class="achievement">‚ö° Alto Rendimiento</div>';
            }
            if (score >= 2500) {
                achievements.innerHTML += '<div class="achievement">üåü Puntuaci√≥n Excelente</div>';
            }
            if (currentQuestion === questions.length) {
                achievements.innerHTML += '<div class="achievement">üíØ Completista</div>';
            }
        }

        function loadRanking() {
            db.collection('players')
                .where('completed', '==', true)
                .orderBy('finalScore', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    const ranking = document.getElementById('rankingList');
                    ranking.innerHTML = '';
                    
                    let position = 1;
                    snapshot.forEach(doc => {
                        const player = doc.data();
                        const item = document.createElement('div');
                        item.className = 'ranking-item';
                        
                        let medal = '';
                        if (position === 1) medal = 'ü•á';
                        else if (position === 2) medal = 'ü•à';
                        else if (position === 3) medal = 'ü•â';
                        
                        item.innerHTML = `
                            <div style="font-weight: bold; font-size: 20px; color: #2c3e50;">${medal} ${position}</div>
                            <div style="flex: 1; text-align: left; margin-left: 15px; font-size: 18px;">${player.name}</div>
                            <div style="font-weight: bold; color: #27ae60; font-size: 20px;">${player.finalScore} pts</div>
                        `;
                        
                        if (player.id === currentPlayer.id) {
                            item.style.background = '#e3f2fd';
                            item.style.borderLeftColor = '#2196f3';
                        }
                        
                        ranking.appendChild(item);
                        position++;
                    });
                });
        }

        async function updateGlobalStats() {
            // Actualizar estad√≠sticas globales
            const statsRef = db.collection('stats').doc('global');
            const stats = await statsRef.get();
            
            if (stats.exists) {
                const currentStats = stats.data();
                await statsRef.update({
                    totalPlayers: currentStats.totalPlayers + 1,
                    totalGames: currentStats.totalGames + 1,
                    averageScore: (currentStats.averageScore * currentStats.totalPlayers + score) / (currentStats.totalPlayers + 1),
                    lastUpdate: new Date()
                });
            } else {
                await statsRef.set({
                    totalPlayers: 1,
                    totalGames: 1,
                    averageScore: score,
                    created: new Date()
                });
            }
        }

        function restartGame() {
            currentQuestion = 0;
            score = 0;
            selectedOption = null;
            
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            questions = [...questionBank].sort(() => Math.random() - 0.5);
            loadQuestion();
            updateScore();
        }

        async function showStats() {
            const stats = await db.collection('stats').doc('global').get();
            const players = await db.collection('players').where('completed', '==', true).get();
            
            let message = 'üìä ESTAD√çSTICAS GLOBALES\n\n';
            
            if (stats.exists) {
                const data = stats.data();
                message += `üë• Total de Jugadores: ${data.totalPlayers || 0}\n`;
                message += `üéÆ Total de Partidas: ${data.totalGames || 0}\n`;
                message += `üìà Puntuaci√≥n Promedio: ${Math.round(data.averageScore || 0)} puntos\n\n`;
            }
            
            message += `üèÜ TOP 5 JUGADORES:\n`;
            const topPlayers = [];
            players.forEach(doc => {
                topPlayers.push(doc.data());
            });
            
            topPlayers.sort((a, b) => b.finalScore - a.finalScore).slice(0, 5).forEach((player, index) => {
                message += `${index + 1}. ${player.name} - ${player.finalScore} pts\n`;
            });
            
            alert(message);
        }

        async function resetGame() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar TODO el juego? Esto borrar√° todos los datos.')) {
                // Borrar todos los datos (solo para administraci√≥n)
                const batch = db.batch();
                
                const players = await db.collection('players').get();
                players.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                const answers = await db.collection('answers').get();
                answers.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                const stats = await db.collection('stats').get();
                stats.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                alert('‚úÖ Todos los datos han sido reiniciados');
                location.reload();
            }
        }

        function showDetailedResults() {
            let message = 'üìã RESULTADO DETALLADO\n\n';
            message += `üéØ Puntuaci√≥n Final: ${score} puntos\n`;
            message += `üìä Porcentaje: ${Math.round((score / 3000) * 100)}%\n`;
            message += `‚úÖ Preguntas Contestadas: ${currentQuestion}/20\n\n`;
            message += 'üìö √ÅREAS EVALUADAS:\n';
            message += '‚Ä¢ IISE Body of Knowledge\n';
            message += '‚Ä¢ Fundamentos del Estudio del Trabajo\n';
            message += '‚Ä¢ Estudio de Tiempos\n';
            message += '‚Ä¢ Herramientas de An√°lisis\n';
            message += '‚Ä¢ Ergonom√≠a y Dise√±o\n';
            
            alert(message);
        }
    </script>
</body>
</html>
